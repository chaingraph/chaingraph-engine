version: '3'

dotenv: ['.env']
silent: true

tasks:
  console:
    cmds:
      - hasura console --project services/hasura --console-port 8080

  seed:
    cmds:
      - hasura seeds apply --project services/hasura 
  
  up:
    cmds:
      - cp modules services/auth/modules
      - cp modules services/core/modules
      - docker-compose up -d --build hasura auth # nginx
      # - docker-compose up -d --build nginx-letsencrypt nginx-gen
      # - docker-compose restart nginx
      # - docker-compose up -d --build core
      - rm -rf services/auth/modules
      - rm -rf services/core/modules
  
  down:
    cmds:
      - docker-compose down -v --remove-orphans

  boot:
    cmds:
      - cp modules services/auth/modules
      - cp modules services/core/modules
      - docker-compose up -d --build hasura auth  # nginx
      - sleep 30
      - hasura migrate apply --project services/hasura 
      - hasura metadata apply --project services/hasura 
      - hasura seeds apply --project services/hasura 
      # - docker-compose up -d --build core
      # - docker-compose up -d --build nginx-letsencrypt nginx-gen
      # - docker-compose restart nginx
      - rm -rf services/auth/modules
      - rm -rf services/core/modules

  boot-prod:
    cmds:
      - docker-compose -f docker-compose.prod.yml up -d --build hasura hasura-bitcash 
      - sleep 60
      - hasura migrate apply --project services/hasura 
      - hasura metadata apply --project services/hasura 
      - hasura seeds apply --project services/hasura 
      - docker-compose -f docker-compose.prod.yml up -d --build core
      - docker-compose -f docker-compose.prod.yml up -d --build nginx-letsencrypt nginx-gen
      - docker-compose -f docker-compose.prod.yml up -d nginx
 
